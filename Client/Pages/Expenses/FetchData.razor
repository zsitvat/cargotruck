@page "/Expenses"
@using Cargotruck.Client.Components

<h3>@localizer["Expenses"]</h3>
<div class="form-group buttons">
    <a class="btn btn-success me-4" href="/Expenses/create"><i class="oi oi-plus"></i> @localizer["Add"]</a>
    <a data-title="@localizer["Settings"]" class="btn btn-light" @onclick="@(() => settings=!settings)"><i class="oi oi-cog"></i></a>
    <button data-title="@localizer["pdf"]" class="btn btn-light" @onclick="@ExportToPdf"><i class="oi oi-document"></i></button>
    <button data-title="@localizer["excel"]" class="btn btn-light" @onclick="@ExportToExcel"><i class="oi oi-spreadsheet"></i></button>
    <button data-title="@localizer["txt"]" class="btn btn-light" @onclick="@(() => ExportToCSV("txt"))"><span class="icon iconify" style="margin:0;" data-icon="material-symbols:text-snippet-outline"></span></button>
    <button data-title="@localizer["csv"]" class="btn btn-light" @onclick="@(() => ExportToCSV("csv"))"><span class="icon iconify" style="margin:0;" data-icon="bi:filetype-csv"></span></button>
    <span class="file-upload-title" import-data-title="@localizer["File_input"]"><UploadFiles page="expenses" StateChanged="StateChanged" /></span>
    <input value="@searchString" @oninput="@Search" placeholder="@(searchString != "" ? searchString : localizer["Search"])" class="form-control inputs input_search" type="search" id="search-input" name="SearchString">
    
    <!--Filter icon-->
    @if (filter == Cargotruck.Shared.Models.Type.salary || filter == Cargotruck.Shared.Models.Type.storage || filter == Cargotruck.Shared.Models.Type.repair || filter == Cargotruck.Shared.Models.Type.task || filter == Cargotruck.Shared.Models.Type.other)
    {
        <button @onclick="@(()=>OnChangeResetFilter())" class="filter-button"><span class="icon iconify filter-icon" data-icon="material-symbols:filter-alt-off"></span></button>
    }
    else
    {
        <button @onclick="@(()=>OnChangeResetFilter())" class="filter-button not-pointer"><span class="icon iconify filter-icon not-pointer" data-icon="material-symbols:filter-alt"></span></button>
    }
    <!--Filter-->
    <select class="form-control filter" @oninput="@((e)=>OnChangeGetFilter(e))" @bind="filter">
        <option value="" selected>@localizer["Nothing"]</option>
        @foreach (var value in Enum.GetValues<Cargotruck.Shared.Models.Type>())
        {
            <option value="@value">@localizer[value.ToString()]</option>
        }
    </select>
    
    <select data-title="@localizer["Currency"]" class="form-control currency" @oninput="@((e)=>OnChangeGetType(e))" @bind="currency">
        <option value="HUF">HUF</option>
        <option value="EUR">EUR</option>
        <option value="USD">USD</option>
        <option value="CZK">CZK</option>
    </select>

    <div class="date-filter" data-title="@localizer["date-filter-info"]">
        <Input class="form-control" type="datetime-local" value="@dateFilter?.StartDate.GetValueOrDefault().ToString("yyyy-MM-ddTHH:mm", CultureInfo.CurrentCulture)" @oninput="@((e)=>{DateStartInput(e);})">
        <Input class="form-control" type="datetime-local" value="@dateFilter?.EndDate.GetValueOrDefault().ToString("yyyy-MM-ddTHH:mm", CultureInfo.CurrentCulture)" @oninput="@((e)=>{DateEndInput(e);})">
    </div>
</div>
<br>

<p class="error">@document_error</p>

@if (currency_api_error != null && currency_api_error != "")
{
    <div class="d-inline-block">
        <button class="no-button currency-api-error-icon error d-inline-block" @onclick="@(() => showError=!showError)">
            <span class="icon iconify d-inline" style="color:darkred;" data-icon="material-symbols:error-circle-rounded-outline"></span>
        </button>
        <p class="error currency-api-error d-inline-block">
            @if (showError)
            {
                @localizer[@currency_api_error]
            }
        </p>
    </div>
}

@if (expenses == null)
{
    <text><p class="text">@localizer["Loading"]</p></text>
}
else if (expenses.Length == 0)
{
    <text><p class="text">@localizer["No_records"]</p></text>
}
else
{
    <div class="col-md-8 stretch-card mb-2 me-3">
        <div class="form-card mb-1 table-width">
            <div class="card-body mb-3">
                <div class="table-responsive fixed-table-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                @if (showColumns[0])
                                {
                                    <th><button class="@(sortOrder=="Type" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Type"))">@localizer["Type"]</button></th>
                                }
                                @if (showColumns[1])
                                {
                                    <th><button class="@(sortOrder=="Type_id" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Type_id"))">@localizer["Type_id"]</button></th>
                                }
                                @if (showColumns[2])
                                {
                                    <th><button class="@(sortOrder=="Fuel" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Fuel"))">@localizer["Fuel"]</button></th>
                                }
                                @if (showColumns[3])
                                {
                                    <th><button class="@(sortOrder=="Road_fees" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Road_fees"))">@localizer["Road_fees"]</button></th>
                                }
                                @if (showColumns[4])
                                {
                                    <th><button class="@(sortOrder=="Penalty" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Penalty"))">@localizer["Penalty"]</button></th>
                                }
                                @if (showColumns[5])
                                {
                                    <th><button class="@(sortOrder=="Driver_spending" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Driver_spending"))">@localizer["Driver_spending"]</button></th>
                                }
                                @if (showColumns[6])
                                {
                                    <th><button class="@(sortOrder=="Driver_salary" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Driver_salary"))">@localizer["Driver_salary"]</button></th>
                                }
                                @if (showColumns[7])
                                {
                                    <th><button class="@(sortOrder=="Repair_cost" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Repair_cost"))">@localizer["Repair_cost"]</button></th>
                                }
                                @if (showColumns[8])
                                {
                                    <th><button class="@(sortOrder=="Repair_description" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Repair_description"))">@localizer["Repair_description"]</button></th>
                                }
                                 @if (showColumns[9])
                                {
                                    <th><button class="@(sortOrder=="Cost_of_storage" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Cost_of_storage"))">@localizer["Cost_of_storage"]</button></th>
                                }
                                 @if (showColumns[10])
                                {
                                    <th><button class="@(sortOrder=="other" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("other"))">@localizer["other"]</button></th>
                                }
                                @if (showColumns[11])
                                {
                                    <th class="last-col"><button class="@(sortOrder=="Date" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Date"))">@localizer["Date"]</button></th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            
                            @foreach (Expenses item in expenses)
                            {

                                <tr @onclick="@((e) =>Pages.MouseOnclick(e,item.Id.ToString()))" @onmouseover="@((e) =>Pages.MouseOver(e,item.Id.ToString()))" @onmouseout="@((e) =>Pages.MouseOut(e))"
                            class="@(Pages.MouseOnHoverClass == item.Id.ToString() || Pages.MouseOnclickClass == item.Id.ToString() ? "color-on-hover" :"")">
                                    <td>@item.Id</td>
                                  
                                    @if (showColumns[0])
                                    {
                                        <td>
                                            @if (item.Type != null)
                                            {
                                                @localizer[item.Type.ToString()!]
                                            }
                                        </td>
                                    }
                                    @if (showColumns[1])
                                    {
                                        if (item.Type_id != null)
                                        {
                                            <td><button class="no-button" @onclick="@(()=>GetById(item.Type_id,item.Type?.ToString()!))">@item.Type_id</button></td>
                                        }
                                    }
                                    @if (showColumns[2])
                                    {
                                         <td>
                                            @if (@item.Fuel != null)
                                            {
                                                @if (currency != "HUF" && Rates != null)
                                                {
                                                    @(GetCurrency(item.Fuel)!.Value.ToString("0.##") + " " + currency)
                                                }
                                                else
                                                {
                                                    @(item.Fuel + " HUF")
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[3])
                                    {
                                        <td>
                                            @if (@item.Road_fees != null)
                                            {
                                                @if (currency != "HUF" && Rates != null)
                                                {
                                                    @(GetCurrency(item.Road_fees)!.Value.ToString("0.##") + " " + currency)
                                                }
                                                else
                                                {
                                                    @(item.Road_fees + " HUF")
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[4])
                                    {
                                         <td>
                                            @if (@item.Penalty != null)
                                                {
                                                @if (currency != "HUF" && Rates != null)
                                                {
                                                    @(GetCurrency(item.Penalty)!.Value.ToString("0.##") + " " + currency)
                                                }
                                                else
                                                {
                                                    @(item.Penalty + " HUF")
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[5])
                                    {
                                        <td>
                                            @if(@item.Driver_spending != null)
                                                {
                                                @if (currency != "HUF" && Rates != null)
                                                {
                                                    @(GetCurrency(item.Driver_spending)!.Value.ToString("0.##") + " " + currency)
                                                }
                                                else
                                                {
                                                    @(item.Driver_spending + " HUF")
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[6])
                                    {
                                         <td>
                                            @if (@item.Driver_salary != null)
                                            {
                                                @if (currency != "HUF" && Rates != null)
                                                {
                                                    @(GetCurrency(item.Driver_salary)!.Value.ToString("0.##") + " " + currency)
                                                }
                                                else
                                                {
                                                    @(item.Driver_salary + " HUF")
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[7])
                                    {
                                        <td>
                                            @if (@item.Repair_cost != null)
                                            {
                                                @if (currency != "HUF" && Rates != null)
                                                {
                                                    @(GetCurrency(item.Repair_cost)!.Value.ToString("0.##") + " " + currency)
                                                }
                                                else
                                                {
                                                    @(item.Repair_cost + " HUF")
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[8])
                                    {
                                        <td>@item.Repair_description</td>
                                    }
                                    @if (showColumns[9])
                                    {
                                        <td>
                                            @if (@item.Cost_of_storage != null)
                                            {
                                                @if (currency != "HUF" && Rates != null)
                                                {
                                                    @(GetCurrency(item.Cost_of_storage)!.Value.ToString("0.##") + " " + currency)
                                                }
                                                else
                                                {
                                                    @(item.Cost_of_storage + " HUF")
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[10])
                                    {
                                        <td>
                                            @if (@item.other != null)
                                            {
                                                @if (currency != "HUF" && Rates != null)
                                                {
                                                    @(GetCurrency(item.other)!.Value.ToString("0.##") + " " + currency)
                                                }
                                                else
                                                {
                                                    @(item.other + " HUF")
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[11])
                                    {
                                        <td>@item.Date</td>
                                    }
                                    <td class="@(Pages.MouseOnHoverClass == item.Id.ToString() || Pages.MouseOnclickClass == item.Id.ToString() ? "show" :"not-show") ">
                                        <a class="btn  fixed" href="Expenses/edit/@item.Id"> <span data-title="@localizer["Edit"]" class="oi oi-pencil" aria-hidden="true"></span></a>
                                        <button class="btn fixed2" @onclick="@(() => Delete(item.Id))"> <span data-title="@localizer["Delete"]" class="oi oi-trash" aria-hidden="true"></span></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <Pagination CurrentPage="currentPage" PageSize="pageSize" DataRows="dataRows" MaxPage="maxPage" GetCurrentPage="GetCurrentPage" />
            </div>
        </div>
    </div>

    <div class="hideandshow-cards">
        @if (settings)
        {
            <Settings OnSettingsClosed="SettingsClosed" OnInputChanged="InputChanged" OnSettingsChanged="SettingsChanged" showColumns="@showColumns" settings="@settings" pageSize="@pageSize" />
        }
        @if (IdForGetById != null)
        {
            <GetbyidComponent getById="@IdForGetById.ToString()" getByIdType="@GetByIdType" OnSetToNull="SetToNull" />
        }
    </div>
}