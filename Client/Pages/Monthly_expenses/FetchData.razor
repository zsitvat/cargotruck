@page "/Monthly_expenses"

<h3>@localizer["Monthly_expenses"]</h3>
<div class="form-group buttons">
    <a class="btn btn-success me-4" href="/Monthly_expenses/create"><i class="oi oi-plus"></i> @localizer["Add"]</a>
    <a data-title="@localizer["Settings"]" class="btn btn-light" @onclick="@(() => settings=!settings)"><i class="oi oi-cog"></i></a>
    <button data-title="@localizer["pdf"]" class="btn btn-light" @onclick="@ExportToPdf"><i class="oi oi-document"></i></button>
    <button data-title="@localizer["excel"]" class="btn btn-light" @onclick="@ExportToExcel"><i class="oi oi-spreadsheet"></i></button>
    <button data-title="@localizer["txt"]" class="btn btn-light" @onclick="@(() => ExportToCSV("txt"))"><span class="icon iconify" style="margin:0;" data-icon="material-symbols:text-snippet-outline"></span></button>
    <button data-title="@localizer["csv"]" class="btn btn-light" @onclick="@(() => ExportToCSV("csv"))"><span class="icon iconify" style="margin:0;" data-icon="bi:filetype-csv"></span></button>
    <input value="@searchString" @oninput="@Search" placeholder="@(searchString != "" ? searchString : localizer["Search"])" class="form-control inputs input_search" type="search" id="search-input" name="SearchString">
</div>
<br>
<p class="error">@document_error</p>

@if (Monthly_expenses == null)
{
    <text>@localizer["Loading"]</text>
}
else if (Monthly_expenses.Length == 0)
{
    <text>@localizer["No_records"]</text>
}
else
{
    <div class="col-md-8 stretch-card mb-2">
        <div class="form-card mb-1 table-width">
            <div class="card-body mb-3">
                <div class="table-responsive fixed-table-body">
                    <table class="table striped">
                        <thead>
                            <tr>
                                <th class="counter-col"> </th>
                                <th><button class="@(sortOrder=="Month" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Month"))">@localizer["Month"]</button></th>
                                @if (showColumns[0])
                                {
                                    <th><button class="@(sortOrder=="Earning" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Earning"))">@localizer["Earning"]</button></th>
                                }
                                @if (showColumns[1])
                                {
                                    <th><button class="@(sortOrder=="Expense" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Expense"))">@localizer["Expense"]</button></th>
                                }
                                @if (showColumns[2])
                                {
                                    <th><button class="@(sortOrder=="Profit" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Profit"))">@localizer["Profit"]</button></th>
                                }
                                @if (showColumns[3])
                                {
                                    <th><button>@localizer["Expenses_id"]</button></th>
                                }
                                @if (showColumns[4])
                                {
                                    <th><button>@localizer["Task_id"]</button></th>
                                }
                                @if (showColumns[5])
                                {
                                    <th class="last-col"><button class=" @(sortOrder=="Date" ? (desc ? "arrow-down" : "arrow-up") : "arrow-no-sorting")" @onclick="@(() => Sorting("Date"))">@localizer["Date"]</button></th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @{int rowCounter = 0 + pageSize * (currentPage-1);}
                            @foreach (Monthly_expenses item in Monthly_expenses)
                            {
                                rowCounter += 1;
                                <tr class="@(item.Profit <=0 ? "red": "")">
                                   @if(item.User_id=="Generated") 
                                   {
                                      <td import-data-title="@localizer["Generated"]">@rowCounter</td>    
                                   }
                                   else
                                   {
                                        <td import-data-title="@localizer["Not_generated"]">@rowCounter*</td>
                                   }
                                    <td>@localizer[item.Date.Month.ToString()]</td>
                                    @if (showColumns[0])
                                    {
                                        <td>@item.Earning</td>
                                    }
                                    @if (showColumns[1])
                                    {
                                        <td>@item.Expense</td>
                                    }
                                    @if (showColumns[2])
                                    {
                                        <td>@item.Profit </td>
                                    }
                                    @if (showColumns[3])
                                    {
                                        <td>
                                            @foreach (var ConId in connection_ids.Where(x => x.Monthly_expense_id == item.Monthly_expense_id && x.Expense_id != null))
                                            {
                                                @if (connection_ids.Where(x => x.Monthly_expense_id == item.Monthly_expense_id && x.Expense_id != null).Last().Id != ConId.Id)
                                                {
                                                    @(ConId.Expense_id + ", ")
                                                }
                                                else
                                                {
                                                    @ConId.Expense_id
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[4])
                                    {
                                        <td>
                                            @foreach (var ConId in connection_ids.Where(x => x.Monthly_expense_id == item.Monthly_expense_id && x.Task_id != null))
                                            {
                                                @if (connection_ids.Where(x => x.Monthly_expense_id == item.Monthly_expense_id && x.Task_id != null ).Last().Id != ConId.Id)
                                                {
                                                    @(ConId.Task_id + ", ")
                                                        
                                                }
                                                else
                                                {
                                                    @ConId.Task_id
                                                }
                                            }
                                        </td>
                                    }
                                    @if (showColumns[5])
                                    {
                                        <td class="last-col">@item.Date</td>
                                    }
                                    <td>
                                        <a class="btn  fixed" href="Monthly_expenses/edit/@item.Monthly_expense_id"> <span data-title="@localizer["Edit"]" class="oi oi-pencil" aria-hidden="true"></span></a>
                                        <button class="btn fixed2" @onclick="@(() => Delete(item.Monthly_expense_id))"> <span data-title="@localizer["Delete"]" class="oi oi-trash" aria-hidden="true"></span></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="align-center pagination-style mt-2"> 
                    @if (currentPage != 1)
                    {
                        <i class="oi oi-media-skip-backward btn btn-pagination" id="prev" @onclick="PrevPage"></i>
                    }else
                    {
                         <i style="opacity:0;" class=" oi oi-media-skip-backward btn btn-pagination"></i>
                    }
                    @for (int i = currentPage - 2; i <= currentPage + 2; i++)
                    {
                        int j = i;
                        @if (i > 0 && i <= maxPage)
                        {
                            if (i == currentPage)
                            {
                                <span class="btn btn-pagination currentpage"  @onclick="() => ShowPage(j)">@i</span>
                            }
                            else
                            {
                                <span class="btn  btn-pagination"  @onclick="() => ShowPage(j)">@i</span>
                            }
                        }

                    }
                    @if(currentPage < maxPage)
                    {
                        <i class="oi oi-media-skip-forward btn btn-pagination" id="next" @onclick="NextPage"></i>
                    }
                    else
                    {
                        <i style="opacity:0;" class="oi oi-media-skip-forward btn btn-pagination"></i>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (settings)
    {
        <Settings OnSettingsClosed="SettingsClosed" OnInputChanged="InputChanged" OnSettingsChanged="SettingsChanged" showColumns="@showColumns" settings="@settings" pageSize="@pageSize" />
    }
    else
    {
        <div class="mb-6"></div>
    }
}
@code {
    public bool settings = false;
    Monthly_expenses[]? Monthly_expenses { get; set; }
    Monthly_expenses_tasks_expenses[]? connection_ids { get; set; }
    List<bool> showColumns = Enumerable.Repeat(true, 16).ToList();
    private int currentPage = 1;
    int pageSize = 10;
    int dataRows;
    float maxPage;
    private string sortOrder = "Month_desc";
    private bool desc = false;
    private string? searchString = "";
    string? document_error;

    protected override async Task OnInitializedAsync()
    {
        PageHistoryState.AddPageToHistory("/Monthly_expenses");
        base.OnInitialized();
        var refreshdata = await client.GetStringAsync("api/Monthly_expenses/createcontable");
        dataRows = await client.GetFromJsonAsync<int>("api/Monthly_expenses/pagecount");
        var checkData = await client.GetAsync("api/Monthly_expenses/checkdata");
        connection_ids = await client.GetFromJsonAsync<Monthly_expenses_tasks_expenses[]?>
        ("api/Monthly_expenses/getconnectionids"); 
        if (checkData.IsSuccessStatusCode) 
        { 
            await ShowPage(); 
            document_error = "";
        }
        else
        {
            document_error = localizer["CheckFailed"];
        }
    }

    async Task Delete(int Id)
    {
        var data = Monthly_expenses.First(x => x.Monthly_expense_id == Id);
        if (await js.InvokeAsync<bool>("confirm", $"{@localizer["Delete?"]} {data.Earning} - {data.Profit} ({data.Monthly_expense_id})"))
        {
            await client.DeleteAsync($"api/Monthly_expenses/delete/{Id}");
            var shouldreload = dataRows % ((currentPage == 1 ? currentPage : currentPage - 1) * pageSize);
            if (shouldreload == 1 && dataRows > 0) { navigationManager.NavigateTo("/Monthly_expenses", true); }
            await OnInitializedAsync();
        }
    }

    protected async Task ShowPage()
    {
        if (pageSize < 1 || pageSize == null) { pageSize = 10; }
        else if (pageSize >= dataRows) { pageSize = dataRows != 0 ? dataRows : 1; }
        maxPage = (int)Math.Ceiling((decimal)((float)dataRows / (float)pageSize));
        Monthly_expenses = await client.GetFromJsonAsync<Monthly_expenses[]>($"api/Monthly_expenses/get?page={currentPage}&pageSize={pageSize}&sortOrder={sortOrder}&desc={desc}&searchString={searchString}&lang={CultureInfo.CurrentCulture.Name.ToString()}");
        StateHasChanged();
    }

    public void SettingsClosed()
    {
        settings = !settings;
    }


    public void SettingsChanged(){}

    public async void InputChanged(int ChangedPageSize )
    {
        pageSize = ChangedPageSize;
        currentPage = 1;
        await ShowPage();
    }

    protected async Task NextPage()
    {
        currentPage++;
        await ShowPage();
    }

    protected async Task ShowPage(int i)
    {
        currentPage = i;
        await ShowPage();
    }

    protected async Task PrevPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await ShowPage();
        }
    }

    protected async void Sorting(string column)
    {
        if (sortOrder == column)
        {
            desc = !desc;
        }
        else
        {
            sortOrder = column;
        }
        await ShowPage();
    }

    protected async Task Search(ChangeEventArgs args)
    {
        searchString = args.Value.ToString();
        await ShowPage();
    }

    private async Task ExportToPdf ()
    {
        //get base64 string from web api call
        var Response = await client.GetAsync($"api/Monthly_expenses/pdf?lang={CultureInfo.CurrentCulture.Name.ToString()}");

        if (Response.IsSuccessStatusCode)
        {
            var base64String = await Response.Content.ReadAsStringAsync();

            Random rnd = new Random();
            int random = rnd.Next(1000000, 9999999);
            string filename = "Monthly_expenses" + random + "_" + DateTime.Now.ToString("dd-MM-yyyy") + ".pdf";

            //call javascript function to download the file
            await  js.InvokeVoidAsync(
                "downloadFile",
                "application/pdf",
                base64String,
                filename);
        }
        else
        {
            document_error = localizer["Document_failder_to_create"];
        }
    }

    private async Task ExportToExcel()
    {
        //get base64 string from web api call
        var Response = await client.GetAsync($"api/Monthly_expenses/excel?lang={CultureInfo.CurrentCulture.Name.ToString()}");

        if (Response.IsSuccessStatusCode)
        {
            var base64String = await Response.Content.ReadAsStringAsync();

            Random rnd = new Random();
            int random = rnd.Next(1000000, 9999999);
            string filename = "Monthly_expenses" + random + "_" + DateTime.Now.ToString("dd-MM-yyyy") + ".xlsx";

            //call javascript function to download the file
            await js.InvokeVoidAsync(
                "downloadFile",
                "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                base64String,
                filename);
        }
        else
        {
            document_error = localizer["Document_failder_to_create"];
        }
    }

    private async Task ExportToCSV(string format)
    {
        //get base64 string from web api call
        var Response = await client.GetAsync($"api/Monthly_expenses/csv?lang={CultureInfo.CurrentCulture.Name.ToString()}");

        if (Response.IsSuccessStatusCode)
        {
            var base64String = await Response.Content.ReadAsStringAsync();

            Random rnd = new Random();
            int random = rnd.Next(1000000, 9999999);
            string filename = "Monthly_expenses" + random + "_" + DateTime.Now.ToString("dd-MM-yyyy") +"."+ format;
            //call javascript function to download the file
            await js.InvokeVoidAsync(
                "downloadFile",
                "text/" + format + ";charset=utf-8",
                base64String,
                filename);
        }
        else
        {
            document_error = localizer["Document_failder_to_create"];
        }
    }

    private async Task StateChanged()
    {
        await OnInitializedAsync();
    }

}