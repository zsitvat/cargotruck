@page "/Monthly_expenses/edit/{Id:int}"
@inject HttpClient http
@inject NavigationManager uriHelper
@inject IJSRuntime js


<Form ButtonText="Update" OnHandleChangeTask="@HandleChangeTask" OnHandleChangeExpense="@HandleChangeExpense" Monthly_expenses="@monthly_expense" OnValidSubmit="@EditMonthlyExpense" TitleText="Edit_monthly_expense" />

@code {
    [Parameter] public int Id { get; set; }
    string[]? selectedTaskId;
    string[]? selectedExpenseId;
    Monthly_expenses? monthly_expense = new Monthly_expenses();
    Monthly_expenses_tasks_expenses? Monthly_expenses_tasks_expenses = new Monthly_expenses_tasks_expenses();

    public async void HandleChangeTask(string[]? selected)
    {
        selectedTaskId = selected;
    }

    public async void HandleChangeExpense(string[]? selected)
    {
        selectedExpenseId = selected;
    }

    protected async override Task OnParametersSetAsync()
    {
        monthly_expense = await http.GetFromJsonAsync<Monthly_expenses>($"api/Monthly_expenses/getById/{Id}");
    }

    async Task EditMonthlyExpense()
    {
        var text = @localizer["Succesfull_update"];
        var IsFirstId = true;
        await http.PutAsJsonAsync("api/monthly_expenses/put", monthly_expense);

        int lenght = 0;
        if (selectedTaskId != null && selectedExpenseId != null)
        {
            lenght = (selectedTaskId.Length > selectedExpenseId?.Length) ? selectedTaskId.Length : selectedExpenseId.Length;
        }
        else if (selectedTaskId == null && selectedExpenseId != null)
        {
            lenght = selectedExpenseId.Length;
        }
        else if (selectedTaskId != null && selectedExpenseId == null)
        {
            lenght = selectedTaskId.Length;
        }
        else
        {
            lenght = 0;
        }

        for (int i = 0; i < lenght; ++i)
        {
            if (selectedTaskId?.Length > i &&  selectedTaskId?[i] == "*") { selectedTaskId = null; }
            if (selectedExpenseId?.Length > i && selectedExpenseId?[i] == "*") { selectedExpenseId = null; }
        }
        Monthly_expenses_tasks_expenses.Monthly_expense_id = Id;

        for (int i = 0; i < lenght; ++i)
        {
            Monthly_expenses_tasks_expenses.Task_id = null;
            Monthly_expenses_tasks_expenses.Expense_id = null;
            if (i > 0) { IsFirstId = false; }       
            if (selectedTaskId != null && selectedTaskId.Length > i && selectedTaskId[i] != null)
            {
                Monthly_expenses_tasks_expenses.Task_id = int.Parse(selectedTaskId[i]);
            }
            if (selectedExpenseId != null && selectedExpenseId.Length > i && selectedExpenseId[i] != null)
            {
                Monthly_expenses_tasks_expenses.Expense_id = int.Parse(selectedExpenseId[i]);
            }
            //Monthly_expenses_tasks_expenses.Monthly_expenses = monthly_expense;
            await http.PostAsJsonAsync($"api/monthly_expenses/postconnectionids?first={IsFirstId}", Monthly_expenses_tasks_expenses);
        }

        await js.InvokeVoidAsync("alert", $"{text}");
        uriHelper.NavigateTo("/Monthly_expenses");

    }

    protected override void OnInitialized()
    {
        PageHistoryState.AddPageToHistory("/Monthly_expenses/edit/{Id:int}");
        base.OnInitialized();
    }

  
}